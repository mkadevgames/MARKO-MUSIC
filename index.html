<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>MARKO-MUSIC</title>
  <style>
    :root{
      --bg:#0f1114;
      --panel:#0d1113;
      --muted:#9aa3a8;
      --accent:#1db954;
      --glass:rgba(255,255,255,0.04);
      --card:#101214;
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071014 0%,#0b0f12 100%);color:#e6eef1}
    .app{display:grid;grid-template-columns:260px 1fr;grid-template-rows:1fr 84px;gap:18px;height:100vh;padding:18px;box-sizing:border-box}
    .sidebar{background:var(--panel);padding:18px;border-radius:14px;display:flex;flex-direction:column;gap:18px}
    .brand{font-weight:700;font-size:18px;letter-spacing:0.6px}
    .nav{display:flex;flex-direction:column;gap:8px}
    .nav button{background:transparent;border:none;color:var(--muted);padding:10px;border-radius:8px;text-align:left;cursor:pointer}
    .nav button.active{background:var(--glass);color:#fff}
    .searchbox{display:flex;gap:8px}
    .searchbox input{flex:1;padding:10px;border-radius:10px;border:0;background:rgba(255,255,255,0.03);color:inherit}
    .library{flex:1;overflow:auto;padding-right:6px}
    .track{display:flex;gap:12px;align-items:center;padding:8px;border-radius:8px;cursor:pointer}
    .track:hover{background:rgba(255,255,255,0.02)}
    .thumb{width:48px;height:48px;border-radius:8px;background:linear-gradient(135deg,#222,#111);display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--muted);flex-shrink:0}
    .meta{flex:1;min-width:0}
    .meta .title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta .artist{font-size:13px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .controls{grid-column:1/3;background:rgba(0,0,0,0.4);border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px}
    .player-left{display:flex;gap:12px;align-items:center}
    .big-thumb{width:64px;height:64px;border-radius:10px;background:#0b0f12}
    .playbtn{width:48px;height:48px;border-radius:50%;border:0;background:linear-gradient(180deg,var(--accent),#0e8b49);color:#08120b;font-size:18px;cursor:pointer}
    .player-mid{flex:1;display:flex;flex-direction:column}
    .progress{height:6px;background:rgba(255,255,255,0.06);border-radius:6px;margin-top:8px;position:relative}
    .progress .bar{height:100%;background:var(--accent);width:0;border-radius:6px}
    .playlist-area{padding:18px;border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);display:flex;flex-direction:column;gap:12px;overflow:auto}
    .header-row{display:flex;justify-content:space-between;align-items:center}
    .btn{padding:8px 12px;border-radius:10px;border:0;background:rgba(255,255,255,0.03);color:var(--muted);cursor:pointer}
    .btn.primary{background:var(--accent);color:#04120a}
    .grid-tracks{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .card{background:var(--card);padding:12px;border-radius:12px;display:flex;gap:12px;align-items:center}
    .small{font-size:13px;color:var(--muted)}
    .footer-note{font-size:12px;color:var(--muted)}
    @media(max-width:900px){.app{grid-template-columns:1fr;grid-template-rows:auto 1fr 84px}.sidebar{order:2;flex-direction:row;overflow:auto;padding:10px}.library{display:none}.playlist-area{padding:12px}}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">MARKO-MUSIC</div>
      <div class="searchbox">
        <input id="searchInput" placeholder="Buscar músicas ou artistas" autocomplete="off">
        <button id="addUrlBtn" class="btn">Adicionar</button>
      </div>
      <div class="nav">
        <button id="btnLibrary" class="active">Biblioteca</button>
        <button id="btnPlaylists">Playlists</button>
        <button id="btnImportExport">Importar / Exportar</button>
        <label style="display:flex;gap:8px;align-items:center;padding-top:8px"><input id="fileAdd" type="file" multiple style="display:none"><button id="btnAddFiles" class="btn">Adicionar arquivos</button></label>
      </div>
      <div class="library" id="libraryList"></div>
      <div class="footer-note">Salvar local: playlists e biblioteca no armazenamento local do navegador</div>
    </aside>

    <main class="playlist-area">
      <div class="header-row">
        <div>
          <div style="font-size:20px;font-weight:700">Tocando agora</div>
          <div class="small" id="nowInfo">Nada tocando</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="playlistName" placeholder="Nome da playlist" style="padding:8px;border-radius:8px;border:0;background:rgba(255,255,255,0.03);color:inherit">
          <button id="savePlaylistBtn" class="btn primary">Salvar Playlist</button>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:flex-start">
        <div style="flex:1">
          <div style="font-weight:600;margin-bottom:8px">Biblioteca</div>
          <div id="tracksContainer" style="display:flex;flex-direction:column;gap:6px"></div>
        </div>
        <div style="width:320px">
          <div style="font-weight:600;margin-bottom:8px">Playlist atual</div>
          <div id="currentPlaylist" style="display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto"></div>
        </div>
      </div>

    </main>

    <div class="controls">
      <div class="player-left">
        <div class="big-thumb" id="playerThumb">MM</div>
        <div style="display:flex;flex-direction:column">
          <div id="playerTitle" style="font-weight:700">Nenhuma faixa</div>
          <div id="playerArtist" class="small">—</div>
        </div>
      </div>
      <div class="player-mid">
        <div style="display:flex;align-items:center;gap:12px">
          <button id="prevBtn" class="btn">◀◀</button>
          <button id="playBtn" class="playbtn">▶</button>
          <button id="nextBtn" class="btn">▶▶</button>
          <div style="margin-left:8px" id="timeInfo">00:00 / 00:00</div>
        </div>
        <div class="progress" id="progressBar" role="progressbar">
          <div class="bar" id="progressFill"></div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px;width:220px">
        <input id="volume" type="range" min="0" max="1" step="0.01" value="0.8">
        <div style="font-size:12px;color:var(--muted)">Toque local, cole URLs de áudio, ou arraste arquivos para a janela</div>
      </div>
    </div>

    <audio id="audio" preload="metadata"></audio>
  </div>

  <script>
    const STORAGE_KEYS = {LIB:'mm_library_v1', PLAYLISTS:'mm_playlists_v1', LAST:'mm_last_v1'}

    function qs(id){return document.getElementById(id)}

    let library = []
    let playlists = []
    let currentList = []
    let currentIndex = -1

    const audio = qs('audio')
    const searchInput = qs('searchInput')
    const libraryList = qs('libraryList')
    const tracksContainer = qs('tracksContainer')
    const currentPlaylist = qs('currentPlaylist')
    const playBtn = qs('playBtn')
    const prevBtn = qs('prevBtn')
    const nextBtn = qs('nextBtn')
    const playerTitle = qs('playerTitle')
    const playerArtist = qs('playerArtist')
    const playerThumb = qs('playerThumb')
    const progressFill = qs('progressFill')
    const progressBar = qs('progressBar')
    const timeInfo = qs('timeInfo')
    const volume = qs('volume')

    function saveState(){
      localStorage.setItem(STORAGE_KEYS.LIB,JSON.stringify(library))
      localStorage.setItem(STORAGE_KEYS.PLAYLISTS,JSON.stringify(playlists))
    }

    function loadState(){
      try{
        const rawLib = localStorage.getItem(STORAGE_KEYS.LIB)
        const rawPl = localStorage.getItem(STORAGE_KEYS.PLAYLISTS)
        library = rawLib ? JSON.parse(rawLib) : []
        playlists = rawPl ? JSON.parse(rawPl) : []
      }catch(e){library=[];playlists=[]}
    }

    function formatTime(sec){
      if(!isFinite(sec) || sec <= 0) return '00:00'
      const s = Math.floor(sec % 60).toString().padStart(2,'0')
      const m = Math.floor(sec / 60).toString().padStart(2,'0')
      return m+':'+s
    }

    function renderLibrary(filter){
      libraryList.innerHTML = ''
      tracksContainer.innerHTML = ''
      const term = filter ? filter.toLowerCase() : ''
      library.forEach((t,idx)=>{
        const visible = term === '' || t.title.toLowerCase().includes(term) || (t.artist||'').toLowerCase().includes(term)
        if(!visible) return
        const node = document.createElement('div')
        node.className = 'track'
        node.innerHTML = '<div class="thumb">'+(t.title ? t.title.slice(0,2).toUpperCase() : 'MM')+'</div>'+
          '<div class="meta">'+
          '<div class="title">'+(t.title||'Sem título')+'</div>'+
          '<div class="artist">'+(t.artist||'Desconhecido')+'</div>'+
          '</div>'+
          '<div style="display:flex;gap:8px"><button class="btn" data-idx="'+idx+'">Play</button><button class="btn" data-add="'+idx+'">+</button></div>'
        libraryList.appendChild(node)

        const clone = node.cloneNode(true)
        clone.querySelector('button[data-idx]')\.addEventListener('click',()=>{playFromLibrary(idx)})
        clone.querySelector('button[data-add]')\.addEventListener('click',()=>{addToCurrent(idx)})
        tracksContainer.appendChild(clone)
      })
    }

    function renderCurrentPlaylist(){
      currentPlaylist.innerHTML = ''
      currentList.forEach((t,i)=>{
        const el = document.createElement('div')
        el.className = 'card'
        el.innerHTML = '<div class="thumb">'+(t.title? t.title.slice(0,2).toUpperCase() : 'MM')+'</div>'+
          '<div style="flex:1;min-width:0">'+
          '<div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+(t.title||'Sem título')+'</div>'+
          '<div class="small">'+(t.artist||'Desconhecido')+'</div>'+
          '</div>'+
          '<div style="display:flex;flex-direction:column;gap:6px"><button class="btn" data-play="'+i+'">▶</button><button class="btn" data-remove="'+i+'">Remover</button></div>'
        currentPlaylist.appendChild(el)
        el.querySelector('button[data-play]')\.addEventListener('click',()=>{startPlayingIndex(i)})
        el.querySelector('button[data-remove]')\.addEventListener('click',()=>{currentList.splice(i,1);renderCurrentPlaylist()})
      })
    }

    function addToLibrary(item){
      const entry = Object.assign({id:Date.now().toString(36),title:item.title||item.url,artist:item.artist||'',url:item.url,cover:item.cover||''},item)
      library.push(entry)
      saveState()
      renderLibrary(searchInput.value)
    }

    function addToCurrent(libIndex){
      const it = library[libIndex]
      if(!it) return
      currentList.push(it)
      renderCurrentPlaylist()
    }

    function playFromLibrary(idx){
      currentList = [library[idx]]
      startPlayingIndex(0)
      renderCurrentPlaylist()
    }

    function startPlayingIndex(i){
      if(i < 0 || i >= currentList.length) return
      currentIndex = i
      const t = currentList[currentIndex]
      audio.src = t.url
      audio.play()
      updatePlayerInfo(t)
      saveLastPlaying(t)
      playBtn.textContent = '▮▮'
    }

    function updatePlayerInfo(t){
      playerTitle.textContent = t.title || 'Sem título'
      playerArtist.textContent = t.artist || 'Desconhecido'
      playerThumb.textContent = (t.title ? t.title.slice(0,2).toUpperCase() : 'MM')
      qs('nowInfo').textContent = (t.title||'Sem título') + ' — ' + (t.artist||'Desconhecido')
    }

    function saveLastPlaying(t){
      try{localStorage.setItem(STORAGE_KEYS.LAST,JSON.stringify({time:Date.now(),track:t}))}catch(e){}
    }

    audio.addEventListener('timeupdate',()=>{
      const pct = audio.duration ? (audio.currentTime / audio.duration) * 100 : 0
      progressFill.style.width = pct+'%'
      timeInfo.textContent = formatTime(audio.currentTime) + ' / ' + formatTime(audio.duration)
    })

    audio.addEventListener('ended',()=>{
      if(currentIndex + 1 < currentList.length){
        startPlayingIndex(currentIndex + 1)
      }else{
        playBtn.textContent = '▶'
      }
    })

    playBtn.addEventListener('click',()=>{
      if(audio.paused){
        if(!audio.src && currentList.length > 0){
          startPlayingIndex(0)
        }else{
          audio.play()
          playBtn.textContent = '▮▮'
        }
      }else{
        audio.pause()
        playBtn.textContent = '▶'
      }
    })

    prevBtn.addEventListener('click',()=>{
      if(currentIndex > 0){startPlayingIndex(currentIndex - 1)}
    })
    nextBtn.addEventListener('click',()=>{
      if(currentIndex + 1 < currentList.length){startPlayingIndex(currentIndex + 1)}
    })

    progressBar.addEventListener('click',(ev)=>{
      const r = progressBar.getBoundingClientRect()
      const x = ev.clientX - r.left
      const pct = Math.max(0,Math.min(1,x / r.width))
      if(audio.duration){audio.currentTime = audio.duration * pct}
    })

    volume.addEventListener('input',()=>{audio.volume = parseFloat(volume.value)})

    qs('btnAddFiles').addEventListener('click',()=>{qs('fileAdd').click()})
    qs('fileAdd').addEventListener('change',(ev)=>{
      const files = Array.from(ev.target.files)
      files.forEach(f=>{
        const url = URL.createObjectURL(f)
        addToLibrary({title:f.name,artist:'Arquivo local',url:url})
      })
    })

    document.addEventListener('dragover',(e)=>{e.preventDefault()})
    document.addEventListener('drop',(e)=>{
      e.preventDefault()
      const items = Array.from(e.dataTransfer.files || [])
      items.forEach(f=>{
        const url = URL.createObjectURL(f)
        addToLibrary({title:f.name,artist:'Arquivo arrastado',url:url})
      })
    })

    qs('addUrlBtn').addEventListener('click',()=>{
      const v = prompt('Cole a URL direta do arquivo de áudio ou um link público que forneça um arquivo de áudio')
      if(v){
        try{
          const url = v.trim()
          const title = prompt('Título da música (opcional)') || url
          const artist = prompt('Artista (opcional)') || ''
          addToLibrary({title:title,artist:artist,url:url})
        }catch(e){alert('Não foi possível adicionar a URL')}
      }
    })

    qs('btnLibrary').addEventListener('click',()=>{qs('btnLibrary').classList.add('active');qs('btnPlaylists').classList.remove('active');qs('btnImportExport').classList.remove('active')})
    qs('btnPlaylists').addEventListener('click',()=>{qs('btnLibrary').classList.remove('active');qs('btnPlaylists').classList.add('active');qs('btnImportExport').classList.remove('active')})

    qs('savePlaylistBtn').addEventListener('click',()=>{
      const name = qs('playlistName').value.trim() || ('Playlist '+(playlists.length + 1))
      const snapshot = currentList.map(t=>t.id || t.url)
      playlists.push({id:Date.now().toString(36),name:name,items:snapshot})
      saveState()
      alert('Playlist salva: '+name)
    })

    qs('btnImportExport').addEventListener('click',()=>{
      const raw = JSON.stringify({library:library,playlists:playlists},null,2)
      const w = window.open('','_blank')
      try{w.document.write('<pre>'+escapeHtml(raw)+'</pre>')}catch(e){alert('Abra as configurações do navegador para permitir popups')}
    })

    function escapeHtml(s){
      return s.replace(/[&<>]/g,function(c){
        return {'&':'&amp;','<':'&lt;','>':'&gt;'}[c]
      })
    }

    searchInput.addEventListener('input',(e)=>{renderLibrary(e.target.value)})

    function init(){
      loadState()
      renderLibrary()
      renderCurrentPlaylist()
      audio.volume = parseFloat(volume.value)
      const lastRaw = localStorage.getItem(STORAGE_KEYS.LAST)
      if(lastRaw){try{const last = JSON.parse(lastRaw);if(last && last.track){playerTitle.textContent = last.track.title;playerArtist.textContent = last.track.artist;playerThumb.textContent = (last.track.title||'MM').slice(0,2).toUpperCase()}}catch(e){}}
    }

    init()
  </script>
</body>
</html>
